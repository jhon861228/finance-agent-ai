---
const username = (Astro.url.searchParams.get("username") || "").trim();
import Layout from "../layouts/Layout.astro";
import {
	getUserByUsername,
	getPersonalExpenses,
	getUserGroups,
	type Expense,
	type Group,
} from "../lib/db";

console.log(`[Dashboard] --- Dashboard Request ---`);
console.log(`[Dashboard] Username: "${username}"`);

if (!username) {
	console.log(`[Dashboard] Redirecting to / because username is empty`);
	return Astro.redirect("/");
}

const user = await getUserByUsername(username);

if (!user) {
	console.log(`[Dashboard] User NOT found: "${username}"`);
	return Astro.redirect("/?error=UserNotFound");
}

console.log(`[Dashboard] User AUTHENTICATED: ${user.name} (${user.userId})`);

const personalExpenses: Expense[] = await getPersonalExpenses(user.userId);
const totalPersonalSpend = user.totalSpent || 0;
const groups: Group[] = await getUserGroups(user.userId);

// Unify expenses with source information
const allExpenses = [
	...personalExpenses.map((e) => ({
		...e,
		source: "Personal",
		sourceType: "personal" as const,
	})),
	...groups.flatMap((g) =>
		g.expenses
			.filter((e) => e.payerId === user.userId)
			.map((e) => ({
				...e,
				source: g.name,
				sourceType: "group" as const,
			})),
	),
].sort((a, b) => b.timestamp - a.timestamp);

const totalPersonal = personalExpenses.reduce(
	(sum: number, e: Expense) => sum + (e.amount || 0),
	0,
);
---

<Layout title="Dashboard">
	<div class="premium-dashboard">
		<!-- Header -->
		<header class="luxury-head">
			<div class="user-pill">
				<div class="avatar-sm">{username[0].toUpperCase()}</div>
				<div class="user-meta">
					<span class="greet">Good Morning,</span>
					<span class="name-bold">{user.name}</span>
				</div>
			</div>
			<div class="notif-bell">
				<span class="bell-icon">üîî</span>
			</div>
		</header>

		<!-- Portfolio Summary -->
		<section class="portfolio-card">
			<span class="portfolio-title">TOTAL WEALTH PORTFOLIO</span>
			<div class="portfolio-amount">
				<span class="currency">$</span>
				<span class="big-gold"
					>{Math.floor(totalPersonalSpend).toLocaleString()}</span
				>
				<span class="cents"
					>.{
						((totalPersonalSpend % 1) * 100)
							.toFixed(0)
							.padStart(2, "0")
					}</span
				>
			</div>
			<div class="trend-pill">
				<span class="trend-icon">üìà</span>
				<span class="trend-val">+12.4% this month</span>
			</div>
		</section>

		<!-- Action Grid -->
		<div class="action-grid">
			<div class="action-item">
				<div class="action-btn-p">
					<span>‚û§</span>
				</div>
				<span class="action-label">SEND</span>
			</div>
			<div class="action-item">
				<div class="action-btn-p">
					<span>üíµ</span>
				</div>
				<span class="action-label">PAY</span>
			</div>
			<div class="action-item">
				<div class="action-btn-p">
					<span>üìà</span>
				</div>
				<span class="action-label">INVEST</span>
			</div>
			<div class="action-item">
				<div class="action-btn-p">
					<span>‚äï</span>
				</div>
				<span class="action-label">TOP UP</span>
			</div>
		</div>

		<!-- Group Cards -->
		<section class="cards-section">
			<div class="sec-header">
				<h2>YOUR GROUPS</h2>
				<a href="#" class="manage-btn">MANAGE</a>
			</div>
			<div class="cards-scroll">
				{
					groups.map((group, index) => (
						<a
							href={`/group/${group.groupId}?username=${username}`}
							class="card-link"
						>
							<div
								class={`premium-card group-card-alt ${index % 2 === 0 ? "gold-border" : "silver-border"}`}
							>
								<div class="card-top">
									<span class="card-title">GROUP ACCESS</span>
									<span class="visa-style">FINANCE</span>
								</div>
								<div class="card-main">
									<h3 class="group-name-card">
										{group.name}
									</h3>
									<div class="card-number-dots">
										{group.members.slice(0, 4).map((m) => (
											<span class="dot">‚óè</span>
										))}
										<span class="num-end">
											{group.groupId.slice(-4)}
										</span>
									</div>
								</div>
								<div class="card-bottom">
									<div class="card-holder">
										<span class="ch-label">MEMBERS</span>
										<span class="ch-name">
											{group.members.length} USERS
										</span>
									</div>
									<div class="card-chip">
										<div class="chip-inner" />
									</div>
								</div>
							</div>
						</a>
					))
				}
				{groups.length === 0 && <p class="muted">No groups yet.</p>}
			</div>
		</section>

		<!-- Activity / Insights -->
		<section class="insights-section">
			<div class="sec-header">
				<h2>MARKET INSIGHTS</h2>
				<a href="#" class="view-all-btn">VIEW ALL</a>
			</div>

			<div class="activity-chart">
				<div class="chart-bars">
					{
						[40, 60, 50, 70, 90, 80, 75, 85].map((h, i) => (
							<div
								class={`bar ${i === 4 ? "highlight" : ""}`}
								style={`height: ${h}%`}
							/>
						))
					}
				</div>
			</div>

			<div class="insights-list">
				{
					allExpenses.slice(0, 5).map((exp) => (
						<div class="insight-item">
							<div class="insight-icon">
								{exp.source[0].toUpperCase()}
							</div>
							<div class="insight-meta">
								<span class="insight-name">
									{exp.description}
								</span>
								<span class="insight-sub">
									{exp.source} ‚Ä¢ {exp.category}
								</span>
							</div>
							<div class="insight-val">
								<span class="val-num gold-text">
									${exp.amount.toFixed(2)}
								</span>
								<span class="val-trend">+2.45%</span>
							</div>
						</div>
					))
				}
			</div>
		</section>
	</div>
</Layout>

<script>
	const filterButtons = document.querySelectorAll(".filter-btn");
	const expenseItems = document.querySelectorAll(".expense-item");

	filterButtons.forEach((btn) => {
		btn.addEventListener("click", () => {
			const filter = (btn as HTMLElement).dataset.filter;

			// Update button state
			filterButtons.forEach((b) => b.classList.remove("active"));
			btn.classList.add("active");

			// Filter items
			expenseItems.forEach((item) => {
				const type = (item as HTMLElement).dataset.type;
				if (filter === "all" || type === filter) {
					item.classList.remove("hidden");
				} else {
					item.classList.add("hidden");
				}
			});
		});
	});
</script>

<style>
	.premium-dashboard {
		display: flex;
		flex-direction: column;
		gap: 2rem;
	}

	.luxury-head {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 0.5rem;
	}

	.user-pill {
		display: flex;
		align-items: center;
		gap: 0.8rem;
	}

	.avatar-sm {
		width: 40px;
		height: 40px;
		background: #f0f0b0;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		font-weight: 800;
		color: #555;
	}

	.greet {
		font-size: 0.75rem;
		color: var(--text-muted);
		display: block;
	}

	.name-bold {
		font-weight: 700;
		font-size: 1rem;
		font-family: "Montserrat", sans-serif;
	}

	.notif-bell {
		width: 45px;
		height: 45px;
		background: #121212;
		border-radius: 50%;
		display: flex;
		justify-content: center;
		align-items: center;
		border: 1px solid rgba(255, 255, 255, 0.05);
	}

	/* Portfolio */
	.portfolio-card {
		background: #0f0f0f;
		border: 1px solid rgba(255, 255, 255, 0.03);
		border-radius: 32px;
		padding: 2.5rem 1.5rem;
		text-align: center;
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
	}

	.portfolio-title {
		font-size: 0.65rem;
		letter-spacing: 0.2em;
		color: #999;
		font-weight: 700;
	}

	.portfolio-amount {
		font-family: "Montserrat", sans-serif;
		font-weight: 800;
	}

	.currency {
		font-size: 1.5rem;
		vertical-align: top;
		margin-right: 4px;
		color: var(--primary);
	}

	.big-gold {
		font-size: 3.5rem;
		color: var(--primary);
		letter-spacing: -2px;
	}

	.cents {
		font-size: 1.5rem;
		color: var(--accent);
		opacity: 0.8;
	}

	.trend-pill {
		background: rgba(46, 204, 113, 0.1);
		color: #2ecc71;
		padding: 6px 14px;
		border-radius: 20px;
		font-size: 0.8rem;
		font-weight: 700;
		width: fit-content;
		align-self: center;
		margin-top: 0.5rem;
	}

	/* Action Grid */
	.action-grid {
		display: grid;
		grid-template-columns: repeat(4, 1fr);
		gap: 1rem;
	}

	.action-item {
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: 0.8rem;
	}

	.action-btn-p {
		width: 55px;
		height: 55px;
		background: #111;
		border: 1px solid rgba(255, 255, 255, 0.05);
		border-radius: 16px;
		display: flex;
		justify-content: center;
		align-items: center;
		font-size: 1.2rem;
		color: var(--primary);
		transition: all 0.2s ease;
	}

	.action-btn-p:hover {
		background: var(--card-bg);
		transform: scale(1.05);
	}

	.action-label {
		font-size: 0.6rem;
		font-weight: 800;
		color: #888;
		letter-spacing: 0.05em;
	}

	/* Cards section */
	.sec-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 1.2rem;
	}

	.sec-header h2 {
		font-size: 0.9rem;
		letter-spacing: 0.05em;
		color: #fff;
	}

	.manage-btn,
	.view-all-btn {
		font-size: 0.7rem;
		font-weight: 800;
		color: var(--primary);
		text-decoration: none;
	}

	.cards-scroll {
		display: flex;
		gap: 1rem;
		overflow-x: auto;
		padding-bottom: 1rem;
		scrollbar-width: none;
	}

	.cards-scroll::-webkit-scrollbar {
		display: none;
	}

	.card-link {
		text-decoration: none;
		min-width: 280px;
	}

	.group-card-alt {
		padding: 1.5rem;
		height: 180px;
		display: flex;
		flex-direction: column;
		justify-content: pool;
		gap: 1.5rem;
	}

	.card-top {
		display: flex;
		justify-content: space-between;
		align-items: center;
	}

	.card-title {
		font-size: 0.6rem;
		color: #888;
		letter-spacing: 0.1em;
	}

	.visa-style {
		font-weight: 800;
		font-style: italic;
		font-size: 0.9rem;
		color: var(--primary);
	}

	.group-name-card {
		font-size: 1.4rem;
		font-family: "Montserrat", sans-serif;
		margin-bottom: 0.2rem;
	}

	.card-number-dots {
		display: flex;
		gap: 8px;
		align-items: center;
		color: #555;
		font-size: 0.8rem;
	}

	.num-end {
		color: #999;
		margin-left: 10px;
		letter-spacing: 4px;
		font-weight: 600;
	}

	.card-bottom {
		margin-top: auto;
		display: flex;
		justify-content: space-between;
		align-items: flex-end;
	}

	.ch-label {
		font-size: 0.5rem;
		color: #666;
		display: block;
		margin-bottom: 2px;
	}

	.ch-name {
		font-size: 0.7rem;
		font-weight: 700;
		text-transform: uppercase;
	}

	.card-chip {
		width: 32px;
		height: 24px;
		background: #444;
		border-radius: 4px;
		display: flex;
		padding: 4px;
	}

	.chip-inner {
		flex: 1;
		border: 1px solid #666;
		border-radius: 2px;
	}

	/* Insights */
	.activity-chart {
		background: #111;
		height: 160px;
		border-radius: 24px;
		margin-bottom: 1.5rem;
		display: flex;
		align-items: flex-end;
		padding: 1.5rem;
		justify-content: space-between;
	}

	.chart-bars {
		width: 100%;
		height: 100%;
		display: flex;
		align-items: flex-end;
		gap: 8px;
	}

	.bar {
		flex: 1;
		background: #222;
		border-radius: 4px;
		transition: all 0.3s ease;
	}

	.bar.highlight {
		background: var(--primary);
	}

	.insight-item {
		display: flex;
		align-items: center;
		gap: 1rem;
		padding: 1rem 0;
		border-bottom: 1px solid rgba(255, 255, 255, 0.03);
	}

	.insight-icon {
		width: 48px;
		height: 48px;
		background: #1a1a1a;
		border-radius: 12px;
		display: flex;
		justify-content: center;
		align-items: center;
		font-weight: 800;
		color: #777;
		border: 1px solid rgba(255, 255, 255, 0.05);
	}

	.insight-meta {
		flex: 1;
		display: flex;
		flex-direction: column;
	}

	.insight-name {
		font-weight: 700;
		font-size: 0.9rem;
	}

	.insight-sub {
		font-size: 0.7rem;
		color: #666;
	}

	.insight-val {
		text-align: right;
		display: flex;
		flex-direction: column;
	}

	.val-num {
		font-weight: 800;
		font-size: 0.95rem;
	}

	.val-trend {
		font-size: 0.65rem;
		color: #2ecc71;
		font-weight: 700;
	}
</style>
