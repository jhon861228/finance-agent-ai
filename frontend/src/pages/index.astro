---
import Layout from "../layouts/Layout.astro";

const BACKEND_URL =
	import.meta.env.PUBLIC_BACKEND_URL || "http://localhost:3000";
const API_KEY = import.meta.env.PUBLIC_API_KEY || "default-secret-key";

let error = "";
let success = "";

if (Astro.request.method === "POST") {
	try {
		const data = await Astro.request.formData();
		const action = data.get("action"); // 'login' or 'register'
		const username = data.get("username")?.toString();
		const password = data.get("password")?.toString();

		if (!username || !password) {
			error = "Username and password are required.";
		} else {
			const endpoint =
				action === "register"
					? "/api/auth/register"
					: "/api/auth/login";
			const response = await fetch(`${BACKEND_URL}${endpoint}`, {
				method: "POST",
				headers: {
					"Content-Type": "application/json",
					"X-API-Key": API_KEY,
				},
				body: JSON.stringify({ username, password }),
			});

			const result = await response.json();

			if (!response.ok) {
				console.error("[Auth Error] Authentication failed:", result);
				error = result.error || "Authentication failed.";
			} else {
				if (action === "register") {
					success = "Registration successful! Please log in.";
				} else {
					Astro.cookies.set("token", result.token, {
						httpOnly: true,
						secure: true,
						path: "/",
						maxAge: 60 * 60 * 24 * 7, // 7 days
					});
					Astro.cookies.set("username", result.user.name, {
						httpOnly: true,
						secure: true,
						path: "/",
						maxAge: 60 * 60 * 24 * 7,
					});
					return Astro.redirect("/dashboard");
				}
			}
		}
	} catch (e) {
		console.error(
			"[Auth Exception] Unexpected error during form submission:",
			e,
		);
		error = "An unexpected error occurred.";
	}
}
---

<Layout title="Welcome - Login">
	<div class="login-container">
		<header>
			<div class="logo">
				<svg
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2"
				>
					<path
						d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"
						stroke-linecap="round"
						stroke-linejoin="round"></path>
				</svg>
				<h1 class="title-gradient">Antigravity Finance</h1>
			</div>
			<p>Your premium personal finance assistant</p>
		</header>

		<section class="glass-panel login-box">
			<h2>Access the Dashboard</h2>
			<p>Login or create an account to view your expenses.</p>

			{error && <div class="error-msg">{error}</div>}
			{success && <div class="success-msg">{success}</div>}

			<form method="POST" class="login-form">
				<div class="input-group">
					<input
						type="text"
						name="username"
						placeholder="Username (e.g. Pepe)"
						required
						autocomplete="username"
					/>
				</div>
				<div class="input-group">
					<input
						type="password"
						name="password"
						placeholder="Password"
						required
						autocomplete="current-password"
					/>
				</div>
				<div class="action-buttons">
					<button
						type="submit"
						name="action"
						value="login"
						class="glow-btn">Login</button
					>
					<button
						type="submit"
						name="action"
						value="register"
						class="glow-btn outline">Register</button
					>
				</div>
			</form>
		</section>

		<footer>
			<p>&copy; 2026 Antigravity Finance. Powered by AI.</p>
		</footer>
	</div>
</Layout>

<style>
	.login-container {
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		min-height: 80vh;
		text-align: center;
	}

	header {
		margin-bottom: 3rem;
	}

	.logo {
		display: flex;
		align-items: center;
		gap: 1rem;
		margin-bottom: 1rem;
	}

	.logo svg {
		width: 48px;
		height: 48px;
		color: var(--primary);
		filter: drop-shadow(0 0 10px var(--primary-glow));
	}

	header p {
		color: var(--text-muted);
		font-size: 1.1rem;
	}

	.login-box {
		padding: 3rem;
		width: 100%;
		max-width: 450px;
	}

	h2 {
		margin-bottom: 1rem;
	}

	.login-box > p {
		color: var(--text-muted);
		margin-bottom: 2rem;
	}

	.error-msg {
		color: #ff4d4d;
		background: rgba(255, 77, 77, 0.1);
		padding: 10px;
		border-radius: 8px;
		margin-bottom: 1rem;
		border: 1px solid rgba(255, 77, 77, 0.3);
	}

	.success-msg {
		color: #4caf50;
		background: rgba(76, 175, 80, 0.1);
		padding: 10px;
		border-radius: 8px;
		margin-bottom: 1rem;
		border: 1px solid rgba(76, 175, 80, 0.3);
	}

	.login-form {
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
	}

	.input-group input {
		width: 100%;
		background: rgba(255, 255, 255, 0.03);
		border: 1px solid var(--glass-border);
		padding: 14px 20px;
		border-radius: 12px;
		color: white;
		font-size: 1rem;
		outline: none;
		transition: border-color 0.3s ease;
	}

	.input-group input:focus {
		border-color: var(--primary);
	}

	.action-buttons {
		display: flex;
		gap: 1rem;
	}

	.action-buttons .glow-btn {
		flex: 1;
	}

	.outline {
		background: transparent !important;
		border: 1px solid var(--primary);
		color: var(--primary);
		box-shadow: none;
	}

	.outline:hover {
		background: rgba(var(--primary-rgb), 0.1) !important;
	}

	footer {
		margin-top: 4rem;
		color: rgba(255, 255, 255, 0.2);
		font-size: 0.9rem;
	}

	:global([data-theme="light"]) .input-group input {
		color: #1a1a1a;
		background: #f8f9fa;
		border-color: #cbd5e1;
	}

	:global([data-theme="light"]) .input-group input:focus {
		border-color: var(--primary);
		background: #ffffff;
	}
</style>
